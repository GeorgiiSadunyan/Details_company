# Реализация добавления записи (ЛР Пункт 2)

## Краткое описание

Реализовано добавление нового поставщика через отдельное окно с использованием паттерна MVC. Для нового окна создан отдельный контроллер `AddSupplierController`.

## Архитектурные решения

### 1. Паттерн MVC для нового окна

#### Model (Модель)
- Используется общий репозиторий `SupplierRepObservable`
- Модель данных: `Supplier` с валидацией полей

#### View (Представление)
- **Главное окно**: `index.html` + `script.js`
  - Открывает новое окно через `window.open()`
  - Принимает уведомления через `postMessage()`
  - Автоматически обновляет список после добавления

- **Окно добавления**: `add_supplier.html` + `add_supplier_script.js`
  - Форма с валидацией на клиенте
  - Отправка данных на сервер через POST
  - Уведомление родительского окна через `postMessage()`
  - Автоматическое закрытие после успешного добавления

#### Controller (Контроллер)
- **SupplierController**: управление главным окном
- **AddSupplierController** (новый): управление процессом добавления
  - Валидация входных данных
  - Создание объекта Supplier
  - Добавление через Observable репозиторий

### 2. Валидация данных

#### Клиентская валидация (JavaScript)
```javascript
- Проверка обязательных полей (name, phone)
- Валидация формата телефона (regex)
- Проверка длины полей (name: 1-100, address: 0-200)
- Визуальная индикация ошибок
```

#### Серверная валидация (Python)
```python
- Проверка наличия обязательных полей
- Валидация через класс Supplier (regex, форматы)
- Проверка уникальности (бизнес-логика)
- Детальные сообщения об ошибках для каждого поля
```

### 3. Обновление главного окна

При успешном добавлении:
1. Окно добавления отправляет сообщение родителю: `postMessage({type: 'supplier_added', supplier_id})`
2. Главное окно получает сообщение в обработчике `window.addEventListener('message')`
3. Автоматически перезагружает текущую страницу: `loadSuppliers(currentPage)`
4. Показывает уведомление об успехе
5. Окно добавления автоматически закрывается через 2 секунды

### 4. Паттерн Observer

При добавлении поставщика:
1. `AddSupplierController` вызывает `repository.add(supplier)`
2. `SupplierRepObservable` (Subject) добавляет запись в БД
3. Subject уведомляет всех наблюдателей: `notify('item_added', supplier)`
4. `ViewObserver` логирует событие в консоль

## Реализованные файлы

### Контроллеры
- `controllers/add_supplier_controller.py` - новый контроллер для добавления

### Представления
- `views/add_supplier.html` - HTML форма добавления
- `views/static/add_supplier_styles.css` - стили формы
- `views/static/add_supplier_script.js` - логика формы

### Обновленные файлы
- `app.py` - добавлен роутинг POST /api/suppliers/add
- `views/static/script.js` - добавлено открытие окна и обработка сообщений
- `views/static/styles.css` - добавлены анимации уведомлений
- `views/index.html` - кнопка "Добавить поставщика" активна

### Диаграммы
- `Diagrams/sequence_diagram_add_supplier.drawio` - диаграмма последовательности
- `Diagrams/class_diagram_lab3_p1.drawio` - обновлена диаграмма классов

## API

### POST /api/suppliers/add

**Request:**
```json
{
  "name": "ООО Поставщик",
  "phone": "+7 (999) 123-45-67",
  "address": "г. Москва, ул. Примерная, д. 1" // необязательно
}
```

**Response (успех):**
```json
{
  "success": true,
  "message": "Поставщик успешно добавлен",
  "supplier_id": 123
}
```

**Response (ошибка валидации):**
```json
{
  "success": false,
  "error": "Ошибка валидации данных",
  "validation_errors": {
    "phone": "Некорректно набран номер! +7 999 123",
    "name": "Некорректное имя поставщика!"
  }
}
```

## Ключевые особенности

1. **Разделение ответственности**: отдельный контроллер для каждого окна
2. **Двухуровневая валидация**: на клиенте и сервере
3. **Паттерн Observer**: уведомление о событиях добавления
4. **Межоконное взаимодействие**: через postMessage API
5. **UX**: автоматическое обновление, уведомления, закрытие окна
6. **Безопасность**: экранирование HTML, валидация на сервере

## Тестирование

Для тестирования:
1. Запустить сервер: `python app.py`
2. Открыть http://localhost:8000
3. Нажать "Добавить поставщика"
4. Заполнить форму и отправить
5. Проверить обновление главного окна

## Диаграмма последовательности

Последовательность действий при добавлении поставщика отражена в файле:
`Diagrams/sequence_diagram_add_supplier.drawio`

Ключевые этапы:
1. Пользователь → Главное окно: клик "Добавить"
2. Главное окно → Окно добавления: window.open()
3. Пользователь → Окно добавления: заполнение данных
4. Окно добавления → HTTP Handler: POST /api/suppliers/add
5. HTTP Handler → AddSupplierController: validate_and_add_supplier()
6. AddSupplierController → Валидация данных
7. AddSupplierController → SupplierRepObservable: add()
8. SupplierRepObservable → Supplier_rep_DB: add()
9. Supplier_rep_DB → БД: INSERT
10. SupplierRepObservable → ViewObserver: notify('item_added')
11. HTTP Handler → Окно добавления: {success: true}
12. Окно добавления → Главное окно: postMessage('supplier_added')
13. Главное окно → Обновление списка
14. Окно добавления → Закрытие

## Диаграмма классов

Обновленная диаграмма классов включает:
- **AddSupplierController** - новый контроллер
- **Add View** - новое представление для формы добавления
- Связи между компонентами
- Обновленный HTTP Handler с поддержкой POST

Файл: `Diagrams/class_diagram_lab3_p1.drawio`

